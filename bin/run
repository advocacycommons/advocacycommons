#!/usr/bin/env bash

pushd `pwd`
scriptpath="$( cd "$(dirname "$0")" ; pwd -P )"
projectroot=`pwd`

# declare colors

pink='\033[0;35m'
green='\033[0;32m'
nc='\033[0m' # No Color

echo -e "${pink}Loading environment variables...${nc}"
source ./bin/env
rvm use "ruby-${AFFINITY_RUBY_VERSION}@${AFFINITY_GEMSET_NAME}"
nvm use ${AFFINITY_NODE_VERSION}
echo -e "${green}...environment variables loaded!${nc}"

echo -e "${pink}Starting background services...${nc}"

if [ `uname` == 'Darwin' ]; then # OSX
  brew services start postgresql
  echo "...postgres is running!"
  brew services start redis
  echo "..redis is running!"
elif [ `uname` == "Linux" ]; then # assume debian. sorry!
  systemctl start postgresql
  echo "...postgres is running!"
  systemctl start redis-server
  echo "..redis is running!"
fi

RUN_AT_EXIT_HOOKS=yes rake environment resque:work QUEUE=* &
echo "...resque is running!"
echo -e "${green}...all background services started!${nc}"

echo -e "${pink}Starting app...${nc}"

gem install bundler
bundle install
npm run rails-server &

echo -e "${pink}"
echo "=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)"
echo "=)           Affinity works is running!         =)"
echo "=)                     ...                      =)"
echo "=)           Open http://localhost:3000         =)"
echo "=)         login as: organizer@member.com       =)"
echo "=)              password: password              =)"
echo "=)                     ...                      =)"
echo "=)                 to shutdown:                 =)"
echo "=)          run 'cat tmp/pids/server.pid'       =)"
echo "=)       kill the PID output by that command    =)"
echo "=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)=)"
echo -e "${nc}"

popd
